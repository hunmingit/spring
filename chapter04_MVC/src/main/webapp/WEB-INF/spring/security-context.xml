<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
   xmlns:security="http://www.springframework.org/schema/security"
   xsi:schemaLocation="http://www.springframework.org/schema/security http://www.springframework.org/schema/security/spring-security.xsd
      http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.0.xsd">
   
   <!-- Bean -->
   <!-- 접근 권한이 없을 때(403) 내가 만든 CustomAccessDeniedHandler 실행 -->
   <bean id="customAccessDenied" 
   class="org.joonzis.security.CustomAccessDeniedHandler"></bean>
   <!-- 로그인 성공했을 때 권한별 리다이렉트 등 후처리 담당 -->
   <bean id="customLoginSuccess" 
   class="org.joonzis.security.CustomLoginSuccessHandler"></bean>
   <!-- password 인코딩 -->
   <!-- 비밀번호 암호화 객체 DB에 저장된 BCrypt 비밀번호와 로그인 입력값 비교 -->
   <!-- mybatis가 이빈이 있으면 자동으로 만들어준다. -->
   <bean id="bcryptPasswordEncoder" 
   class="org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder"></bean>
   <!-- 사용자 인증 정보를 db에서 가져온다.-->
   <bean id="customUserDetailService"
   class="org.joonzis.security.CustomUserDetailService"></bean>
   
   <!-- HTTP 통신 보안 구성 요소 Spring Security 기본 필터 체인 자동 등록-->
   <security:http auto-config="true">
   		<!-- permitAll 기본 권한-->
   		<!-- /sample/all 경로는 로그인 없이 누구나 접근 가능 -->
   		<security:intercept-url pattern="/sample/all" access="permitAll"/>
   		<!-- hasRole() ROLE_MEMBER 권한이 있는지 체크하는 함수 -->
 		<security:intercept-url pattern="/sample/member" access="hasRole('ROLE_MENAGER')"/>
 		<!-- /sample/admin 접근 조건 ROLE_ADMIN 권한 필요 -->
 		<security:intercept-url pattern="/sample/admin" access="hasRole('ROLE_ADMIN')"/>
  		
     <!-- <security:form-login/> 기존 로그인 페이지를 커스텀 하기위해 주석처리하고 밑 코드로 설정-->
      <security:form-login 
      login-page="/customLogin"/>
      <security:logout
      logout-url="/customLogout"
      invalidate-session="true"
      delete-cookies="remember-me"/>
      
      <!-- access제한됐을 때 이 경로로 가겠다.지금은 CommonController컨트롤러로 이동 -->
     <!--<security:access-denied-handler error-page="/accessError"/> --> 
      <security:access-denied-handler ref="customAccessDenied"/>
      
      <!-- CSRF 보호 기능 비활성화, 학습/테스트 환경에서 편의상 사용 실무에서는 보통 활성화-->
      <security:csrf disabled="true"/>
      <!-- remember-me 설정  토큰 설정은 일주일 정도 604800/60/60/24 = 7-->
      <security:remember-me
         data-source-ref="dataSource"
         token-validity-seconds="604800"/>

   </security:http>
   
   
   <!-- 사용자 인증 관리 -->
   <security:authentication-manager>
   <!-- 사용자 인증 정보를 db에서 가져온다. -->
   		<security:authentication-provider user-service-ref="customUserDetailService">
   		<!-- db에 있는 계정 정보를 가져온다. -->
   			<!-- <security:jdbc-user-service data-source-ref="dataSource"
   			users-by-username-query="select userid, userpw, 1 from tbl_member where userid=?"
   			authorities-by-username-query="select userid, auth from tbl_member_auth where userid=?"/> -->
   			<security:password-encoder ref="bcryptPasswordEncoder"/>
   			
   			  			
   			<!-- 계정 정보 임시로 만듬 {noop}은 자체 인코딩 암호화 authorities 는  권한 들 -->
   			<!-- 로그인 정보로 로그인 하게 되면 member.jsp로 정상적으로 이동된다. -->
   			<!-- 로그아웃 버튼 설정이 없으므로 쿠키에서 삭제 시키고 새로고침 하면 다시 로그인 화면으로 이동된다. -->
   			<!-- member 계정으로 admin 로그인 하면 403 forbidden 에러 출력됨  -->
   			<!-- 하지만 실제 웹사이트는 권한 관련도 404로 출력하게 한다. -->
   				<!-- <security:user name="member" password="{noop}member" authorities="ROLE_MEMBER"/>
   				<security:user name="admin" password="{noop}admin" authorities="ROLE_MEMBER, ROLE_ADMIN"/> -->
   			
   		</security:authentication-provider>
   </security:authentication-manager>
</beans>
