<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.hati.room.mapper.RoomMapper">

    <!-- 센터 리스트 조회 -->
    <select id="getCenterList" parameterType="map" resultType="org.hati.room.vo.CenterVO">
        SELECT 
            c.center_id AS centerId,
            c.name,
            c.subtitle,
            c.category,
            c.region,
            c.latitude,
            c.longitude,
            c.created_at AS createdAt,
            st.price AS price,
            COUNT(r.room_id) AS roomCount
        FROM centers c
        LEFT JOIN rooms r ON c.center_id = r.center_id
        LEFT JOIN sports_type st ON r.sports_id = st.sports_id
        WHERE 1=1
        <if test="region != null and region != ''">
            AND c.region = #{region}
        </if>
        <if test="category != null and category != ''">
            AND c.category = #{category}
        </if>
        GROUP BY c.center_id, c.name, c.subtitle, c.category, c.region, 
                 c.latitude, c.longitude, c.created_at, st.price
        <choose>
            <when test="sortType == 'price_asc'">
                ORDER BY st.price ASC
            </when>
            <when test="sortType == 'price_desc'">
                ORDER BY st.price DESC
            </when>
            <otherwise>
                ORDER BY c.created_at DESC
            </otherwise>
        </choose>
    </select>

    <!-- 센터 상세 조회 -->
    <select id="getCenterDetail" parameterType="int" resultMap="centerDetailMap">
        SELECT 
            c.center_id,
            c.name,
            c.subtitle,
            c.category,
            c.region,
            c.latitude,
            c.longitude,
            c.created_at,
            st.price,
            r.room_id
        FROM centers c
        LEFT JOIN rooms r ON c.center_id = r.center_id
        LEFT JOIN sports_type st ON r.sports_id = st.sports_id
        WHERE c.center_id = #{centerId}
        ORDER BY r.room_id
    </select>

    <resultMap id="centerDetailMap" type="org.hati.room.vo.CenterVO">
        <id property="centerId" column="center_id"/>
        <result property="name" column="name"/>
        <result property="subtitle" column="subtitle"/>
        <result property="category" column="category"/>
        <result property="region" column="region"/>
        <result property="latitude" column="latitude"/>
        <result property="longitude" column="longitude"/>
        <result property="createdAt" column="created_at"/>
        <result property="price" column="price"/>
        
        <collection property="rooms" ofType="org.hati.room.vo.RoomVO">
            <id property="roomId" column="room_id"/>
            <result property="centerId" column="center_id"/>
            <result property="sportsId" column="sports_id"/>
        </collection>
    </resultMap>

</mapper>